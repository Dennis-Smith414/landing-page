(()=>{var p={maptiles:"https://tiles.search.brave.com/maptiles",premium:"https://account.brave.com/?intent=checkout&product=search",production:!0,watch_mode:!1};var{document:m,cookieStore:w}=self,r=p.production?()=>{}:console.log.bind(console,"[sw]"),b=console.error.bind(console,"[sw]");m?v():S();function v(){if(navigator.serviceWorker&&navigator.brave){r("registerSW function called");let t=m.currentScript.src;navigator.serviceWorker.register(t,{scope:"/"}).then(e=>{e.installing?r("Service worker installing"):e.waiting?r("Service worker installed"):e.active&&r("Service worker active"),e.addEventListener("updatefound",()=>{r("SW updated.")})}).catch(e=>{r("Service worker registration failed:",e)})}}function k(t){return t.replace("<main ",'<main class="d-invisible" ').replace("<main>",'<main class="d-invisible">')}function y(t,e,s){let n=t.indexOf('id="js-gmix"');return n!==-1?`${t.slice(0,n)} data-sw="${encodeURIComponent(JSON.stringify({body:e,browserApiVersion:s}))}" ${t.slice(n)}`:t}async function R({country:t,language:e,url:s,query:n,safesearch:i}){r("fallback with parameters",{country:t,language:e});try{return[await self.brave.fetchBackupResults(n,e||"",t||"",""),1]}catch(a){if(a.message!=="Insufficient number of arguments.")throw a}try{return[await self.brave.fetchBackupResults(n,e||"",t||"","",i!=="off"),2]}catch(a){if(a.message!=="Insufficient number of arguments.")throw a}try{let a=0,c=s.searchParams.get("offset");if(c)try{a=Number(c)*10}catch{}return[await self.brave.fetchBackupResults(n,e||"",t||"","",i!=="off",a),3]}catch(a){if(a.message!=="Insufficient number of arguments.")throw a}}async function x(t,e,s){let n=new URL(e.url);n.searchParams.set("is_fallback_api_available",s?"true":"false");let i=fetch(new Request(n.href,{method:e.method,headers:e.headers,mode:"same-origin",credentials:e.credentials,cache:e.cache,redirect:e.redirect,referrer:e.referrer,integrity:e.integrity,body:e.body}));try{if((await w.get("fallback"))?.value!=="1")return r("user did not opt-in to fallback. Abort!"),i;let{found:a,error:c,country:f,language:u,safesearch:l}=await W(t,n);if(r("can answer query?",t,a,c),c)return r("can answer query error"),i;if(!a){let[d,g]=await R({country:f,language:u,url:n,query:t,safesearch:l});if(d){r("got backup results for",t,d.length);let o=await i;if(o.type!=="basic")return o;let h=await o.text();return h.indexOf('id="js-gmix"')!==-1?new Response(k(y(h,d,g)),{status:o.status,statusText:o.statusText,headers:o.headers}):(r("couldn't find js-gmix bundle"),new Response(h,{status:o.status,statusText:o.statusText,headers:o.headers}))}else r("failed to fetch backup results");return i}return i}catch(a){r("unexpected error",a)}return i}async function I(t,e,s){try{return await x(t,e,s)}catch(n){b("respondWith error",n)}return fetch(e)}function S(){let t=!1;self.brave?.fetchBackupResults?(r("using native browser API"),t=!0):r("no native browser API"),self.addEventListener("install",()=>{r("got install event"),self.skipWaiting()}),self.addEventListener("fetch",async e=>{if(e.clientId)return;if(!t){r("fallback API is not available. Abort!");return}if(!w){r("cookie store is not available. Abort!");return}let s=new URL(e.request.url);if(s.pathname!=="/search"){r("ignoring pathname different from /search",s.pathname);return}let n=s.searchParams.get("q");if(!n){r("ignoring request without a query");return}r("got fetch event",s.searchParams,e),e.respondWith(I(n,e.request,t))})}async function W(t,{searchParams:e}){let s=`/api/can_answer?q=${encodeURIComponent(t)}`;e.has("country")&&(s+=`&country=${encodeURIComponent(e.get("country"))}`),e.has("lang")&&(s+=`&language=${encodeURIComponent(e.get("lang"))}`),e.has("safesearch")&&(s+=`&safesearch=${encodeURIComponent(e.get("safesearch"))}`);let n=Date.now(),i;try{i=await(await fetch(s,{method:"GET",credentials:"include",cache:"no-cache"})).json()}catch(l){return r("error fetching can_answer",l),{error:!0}}let a=Date.now();if(r("Got answer from /can_answer",a-n,i),!("found"in i))return{error:!0};let{language:c,country:f,safesearch:u}=i;return{found:!!i.found,found_fresh:!!i.found_fresh,language:c,country:f==="all"?"us":f,safesearch:u}}})();
